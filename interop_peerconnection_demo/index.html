<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<title>My First WebRTC App</title>
		<script src="/_ah/channel/jsapi"></script>
	</head>
	<body>
		<script type="text/javascript">
			var socket;
			var localPC;
			var remote_client_id;

			var SessionDescription;
			var getUserMedia;
			var RTCPeerConnection;
			var IceCandidate;
			var pc_constraints;

			var iceConfig = {"iceServers":[{"url":"stun:23.21.150.121"}]};

			if(navigator.userAgent.match("(Chrome)")) {
				RTCPeerConnection = webkitRTCPeerConnection;
				getUserMedia = navigator.webkitGetUserMedia.bind(navigator);
				SessionDescription = RTCSessionDescription;
				IceCandidate = RTCIceCandidate;
				pc_constraints = { 'optional': [{'DtlsSrtpKeyAgreement': 'true'}]};
			} else {
				RTCPeerConnection = mozRTCPeerConnection;
				getUserMedia = navigator.mozGetUserMedia.bind(navigator);
				SessionDescription = mozRTCSessionDescription;
				IceCandidate = mozRTCIceCandidate;
				pc_constraints = null;
			}

			function onChannelOpened() {
				console.log('Channel opened');
			}

			function remoteAnswerReceived(msg) {
				var remoteSessionDescription = new SessionDescription({
					'type': msg.type,
					'sdp': msg.sdp
				});

				remote_client_id = msg.client_id;

				localPC.setRemoteDescription(remoteSessionDescription, function() {
					console.log('handshake finished');
				}, function(err) {
					console.log('local pc set remote description error with: ' + err);
				});
			}

			function remoteOfferReceived(msg) {
				var remoteSessionDescription = new SessionDescription({
					'type': msg.type,
					'sdp': msg.sdp
				});

				remote_client_id = msg.client_id;

				localPC.setRemoteDescription(remoteSessionDescription, function() {
					localPC.createAnswer(function(answerSDP) {
						localPC.setLocalDescription(answerSDP, function() {
							submitAnswer(msg.client_id, answerSDP);					
						}, function(err) {
							console.log('local pc set local description error with : ' + err);
						});
					}, function(err) {
						console.log('local pc create answer error with : ' + err);
					});
				}, function(err) {
					console.log('local pc set remote description error with: ' + err);
				});
			}

			function remoteCandidateReceived(msg) {
				var iceCandidate = new IceCandidate({
					'sdpMLineIndex': msg.label,
					'sdpMid': msg.id,
					'candidate': msg.candidate
				});

				remote_client_id = msg.client_id;

				console.log('About to add an ice candidate: ' + msg.candidate);

				localPC.addIceCandidate(iceCandidate);
			}

			function onChannelMessage(message) {
				var msg = JSON.parse(message.data);

				if(msg.type === 'offer') {
					remoteOfferReceived(msg);
				} else if(msg.type === 'answer') {
					remoteAnswerReceived(msg);
				} else if(msg.type === 'candidate') {
					remoteCandidateReceived(msg);
				} else {
					console.log('Unknown message received');
				}
			}

			function onChannelError() {
				console.log('Channel error received');
			}

			function onChannelClosed() {
				console.log('Channel closed');
			}

			function openChannel(channelToken) {
				var channel = new goog.appengine.Channel(channelToken);
				var handler = {
					'onopen': onChannelOpened,
					'onmessage': onChannelMessage,
					'onerror': onChannelError,
					'onclose': onChannelClosed
				};
				socket = channel.open(handler);
			}

			function sendDataToRemoteClient(remoteId, data) {
				var path = 'send?remoteClientId=' + remoteId;
				var xhr = new XMLHttpRequest();
				xhr.open('POST', path, true);
				xhr.send(data);
			}
			
			function submitRemoteClientId() {
				localPC.createOffer(function(sdp) {
					localPC.setLocalDescription(sdp, function() {
						var remoteClientIdRequested = document.getElementById('remoteClientIdRequested');
						remote_client_id = remoteClientIdRequested.value;
						sendDataToRemoteClient(remote_client_id, JSON.stringify({
							'client_id': '{{ client_id }}',
							'type': 'offer',
							'sdp': localPC.localDescription.sdp
						}));	
					}, function(err) {
						console.log('local set local description failed with: ' + err);
					});
				}, function(err) {
					console.log('local create offer failed with: ' + err);
				});
			}

			function submitAnswer(remoteId, answerSDP) {
				sendDataToRemoteClient(remoteId, JSON.stringify({
					'client_id': '{{ client_id }}',
					'type': 'answer',
					'sdp': answerSDP.sdp
				}));
			}

			function playStream(element_id, stream) {
				var element = document.getElementById(element_id);
				element.src = URL.createObjectURL(stream);
				element.play();
			}

			function setupLocalPeer() {
				localPC = new RTCPeerConnection(iceConfig, pc_constraints);

				getUserMedia({video: true, audio: true}, function(stream) {
					playStream('localClientVideo', stream);
					localPC.addStream(stream);

					localPC.onaddstream = function(event) {
						playStream('remoteClientVideo', event.stream);
					};

					localPC.onicecandidate = function(event) {
						if(event.candidate) {
							console.log('onicecandidate fired with a candidate: ' + event.candidate.candidate);

							sendDataToRemoteClient(remote_client_id, JSON.stringify({
								'client_id': '{{ client_id }}',
								'type': 'candidate',
								'label': event.candidate.sdpMLineIndex,
								'id': event.candidate.sdpMid,
								'candidate': event.candidate.candidate
							}));
						} else {
							console.log('onicencandidate fired with a null candidate');
						}
					};
				}, function(err) {
					console.log("local gUM failed with: " + err);
				});
			}

			function initialize() {
				openChannel('{{ token }}');

				var localClientId = document.getElementById('localClientId');
				localClientId.textContent = '{{ client_id }}'

				setupLocalPeer();

				document.getElementById('remoteClientIdSubmit').onclick = submitRemoteClientId;
			}

			window.addEventListener("DOMContentLoaded", initialize);
		</script>
		<div id="container">
			<div>
				<h2>Local Client</h2>
				<div>
					<h3>Your Local Client Id</h3>
					<p id="localClientId"></p>
				</div>
				<div>
					<h3>Your Local Video</h3>
					<video id="localClientVideo" controls></video>
				</div>
			</div>
			<div>
				<h2>Remote Client</h2>
				<div>
					<h3>Register Remote Client Id</h3>
					<input id="remoteClientIdRequested" type="text">
					<input id="remoteClientIdSubmit" type="submit" value="Register">
				</div>
				<div>
					<h3>Your Remote Video</h3>
					<video id="remoteClientVideo" controls></video>
				</div>
			</div>
		</div>
	</body>
</html>
